{% extends "account/base.html" %}

{% block title %}Nearby Sellers{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow-sm p-4">
            <h3 class="card-title text-center mb-3">Nearby Sellers</h3>
            <p class="text-center text-muted mb-4">
                See all sellers near you on the map. Update your current location to find the nearest sellers.
            </p>

            <button id="update-btn" class="btn btn-primary d-block mx-auto mb-3">üìç Update My Location</button>

            <div id="map" style="height: 75vh; width: 100%; border-radius: 8px; border:2px solid #ccc;"></div>
        </div>
    </div>
</div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<style>
.popup-content { text-align:center; }
.popup-content img {
    width: 70px; height: 70px;
    border-radius: 50%; object-fit: cover; margin-bottom:5px;
    border: 2px solid #333;
}
.popup-content a { text-decoration:none; color:#007bff; }
#update-btn { 
    position: absolute; top:100px; right:30px; z-index:1000; 
    padding:10px 18px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer;
    font-size:16px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
#update-btn:hover { background:#0056b3; }
</style>

<script>
var map = L.map('map').setView([20.5937, 78.9629], 5);

// OSM Tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

// Marker cluster
var markers = L.markerClusterGroup();
var myMarker = null;

var icons = {
    seller: L.icon({ iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png', iconSize:[32,32], iconAnchor:[16,32] }),
    customer: L.icon({ iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png', iconSize:[32,32], iconAnchor:[16,32] }),
    self: L.icon({ iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png', iconSize:[32,32], iconAnchor:[16,32] })
};

// Update current user location
document.getElementById("update-btn").addEventListener("click", function() {
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(function(pos){
            var lat = pos.coords.latitude;
            var lng = pos.coords.longitude;

            if(myMarker){ map.removeLayer(myMarker); }

            myMarker = L.marker([lat, lng], {icon: icons.self})
                .addTo(map)
                .bindPopup("<b>You are here</b>")
                .openPopup();

            map.setView([lat,lng],12);

            fetch("{% url 'update_location' %}", {
                method:"POST",
                headers:{
                    "Content-Type":"application/json",
                    "X-CSRFToken":"{{ csrf_token }}"
                },
                body: JSON.stringify({latitude:lat, longitude:lng})
            })
            .then(res => res.json())
            .then(data => { alert(data.status + ": " + (data.message || "Location updated")); });
        });
    } else { alert("Geolocation not supported!"); }
});

// Fetch all sellers
fetch("{% url 'all_sellers' %}")
.then(res => res.json())
.then(data => {
    var tempMarkers = [];
    data.forEach(u => {
        var icon = (u.type=="seller") ? icons.seller : icons.customer;
        console.log(u.id)

        // Profile URL for seller
        var profileUrl = (u.type=="seller") ? `/product/sellers/${u.id}/products/` : '#';

        var popup = `
            <div class="popup-content">
                <a href="${profileUrl}" target="_blank">
                    <img src="${u.photo || 'https://via.placeholder.com/70'}" alt="Profile">
                </a>
                <b>${u.name}</b><br/>
                <a href="tel:${u.phone}">üìû ${u.phone}</a>
            </div>
        `;
        var m = L.marker([u.lat, u.lng], {icon: icon}).bindPopup(popup);
        markers.addLayer(m);
        tempMarkers.push(m);
    });
    map.addLayer(markers);
    if(tempMarkers.length>0){ map.fitBounds(markers.getBounds()); }
});
</script>
{% endblock %}
