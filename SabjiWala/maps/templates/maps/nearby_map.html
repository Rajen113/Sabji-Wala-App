{% extends "account/base.html" %}

{% block title %}Nearby Sellers{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow-sm p-4">
            <h3 class="card-title text-center mb-3">Nearby Sellers</h3>
            <p class="text-center text-muted mb-4">
                See all sellers near you on the map. Update your location to find sellers nearby.
            </p>

            <button id="update-btn" class="btn btn-primary mb-3">üìç Update My Location</button>

            <div id="map" style="height:75vh; width:100%; border-radius:10px; border:2px solid #ccc;"></div>
        </div>
    </div>
</div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<style>
.popup-content { text-align:center; }
.popup-content img {
    width: 80px; height: 80px;
    border-radius: 50%; object-fit: cover; margin-bottom:5px;
    border: 2px solid #007bff;
}
#update-btn { 
    position: absolute; top:90px; right:30px; z-index:1000; 
    padding:10px 18px; background:#007bff; color:white; border:none; border-radius:8px; cursor:pointer;
}
</style>

<script>
var map = L.map('map').setView([20.5937, 78.9629], 5); // India center
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

var markers = L.markerClusterGroup();
var myMarker = null;

var icons = {
    seller: L.icon({ iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png', iconSize:[32,32], iconAnchor:[16,32] }),
    self: L.icon({ iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png', iconSize:[32,32], iconAnchor:[16,32] })
};

// Load sellers from Django context
var sellers = {{ sellers}};


sellers.forEach(u => {
    var popup = `
        <div class="popup-content">
            <a href="#"><img src="${u.photo || 'https://via.placeholder.com/80'}" alt="Profile"></a>
            <b>${u.name}</b><br/>
            <a href="tel:${u.phone}">üìû ${u.phone}</a>
        </div>
    `;
    var m = L.marker([u.lat, u.lng], {icon: icons.seller}).bindPopup(popup);
    markers.addLayer(m);
});
map.addLayer(markers);

// Update current user location
document.getElementById("update-btn").addEventListener("click", function(){
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(function(pos){
            var lat = pos.coords.latitude;
            var lng = pos.coords.longitude;

            if(myMarker){ map.removeLayer(myMarker); }

            myMarker = L.marker([lat,lng], {icon: icons.self})
                .addTo(map)
                .bindPopup("<b>You are here</b>")
                .openPopup();

            map.setView([lat,lng], 13);

            // Send location to backend
            fetch("{% url 'update_location' %}", {
                method: "POST",
                headers: {"Content-Type": "application/x-www-form-urlencoded", "X-CSRFToken": "{{ csrf_token }}"},
                body: `latitude=${lat}&longitude=${lng}`
            });
        });
    } else { alert("Geolocation not supported!"); }
});
</script>
{% endblock %}
