{% extends "account/base.html" %}

{% block title %}Nearby Sellers{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow-sm p-4 position-relative">
            <h3 class="card-title text-center mb-3">Nearby Sellers</h3>
            <p class="text-center text-muted mb-4">
                See all sellers near you on the map. Update your location to find sellers within 1 km.
            </p>

            <button id="update-btn" class="btn btn-primary mb-3">üìç Update My Location</button>

            <div id="map" style="height:75vh; width:100%; border-radius:10px; border:2px solid #ccc;"></div>
        </div>
    </div>
</div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<style>
.popup-content { text-align:center; }
.popup-content img {
    width: 80px; height: 80px;
    border-radius: 50%; object-fit: cover; margin-bottom:5px;
    border: 2px solid #007bff; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    transition: transform 0.2s;
}
.popup-content img:hover { transform: scale(1.1); }
.popup-content a { text-decoration:none; color:#007bff; font-weight:500; }

#update-btn { 
    position: absolute; top:90px; right:30px; z-index:1000; 
    padding:10px 18px; background:#007bff; color:white; border:none; border-radius:8px; cursor:pointer;
    font-size:16px; box-shadow: 0 3px 8px rgba(0,0,0,0.3);
}
#update-btn:hover { background:#0056b3; }

.circle-tooltip {
    background-color: rgba(0,123,255,0.2);
    color: #007bff;
    font-weight: bold;
    font-size: 14px;
    text-align: center;
    border-radius: 5px;
    padding: 2px 5px;
}
</style>

<script>
var map = L.map('map').setView([20.5937,78.9629],5);
var markers = L.markerClusterGroup();
var myMarker = null;
var radiusCircle = null;
var radiusTooltip = null;

var icons = {
    seller: L.icon({ iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png', iconSize:[32,32], iconAnchor:[16,32] }),
    customer: L.icon({ iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png', iconSize:[32,32], iconAnchor:[16,32] }),
    self: L.icon({ iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png', iconSize:[32,32], iconAnchor:[16,32] })
};

// OSM Tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

// Update current location & show 1 km radius
function updateMap(lat, lng){
    if(myMarker){ map.removeLayer(myMarker); }
    if(radiusCircle){ map.removeLayer(radiusCircle); }
    if(radiusTooltip){ map.removeLayer(radiusTooltip); }
    markers.clearLayers();

    myMarker = L.marker([lat,lng], {icon: icons.self})
        .addTo(map)
        .bindPopup("<b>You are here</b>")
        .openPopup();

    // 1 km circle
    radiusCircle = L.circle([lat,lng], {
        color: '#007bff',
        fillColor: '#007bff',
        fillOpacity: 0.1,
        radius: 1000,
        weight: 2
    }).addTo(map);

    radiusTooltip = L.tooltip({
        permanent:true,
        direction:'center',
        className:'circle-tooltip'
    })
    .setContent('1 km range')
    .setLatLng([lat,lng])
    .addTo(map);

    // Fetch all sellers and filter 1 km
    fetch("{% url 'all_sellers' %}")
    .then(res=>res.json())
    .then(data=>{
        data.forEach(u=>{
            var distance = map.distance([u.lat,u.lng],[lat,lng]);
            if(distance <= 1000){
                var popup = `
                    <div class="popup-content">
                        <a href="{% url 'seller_products' u.id %}" target="_blank">
                            <img src="${u.photo || 'https://via.placeholder.com/80'}" alt="Profile">
                        </a>
                        <b>${u.name}</b><br/>
                        <a href="tel:${u.phone}">üìû ${u.phone}</a>
                    </div>
                `;
                L.marker([u.lat,u.lng], {icon: icons.seller}).bindPopup(popup).addTo(markers);
            }
        });
        map.addLayer(markers);
        if(markers.getLayers().length > 0){ map.fitBounds(markers.getBounds().pad(0.3)); }
    });
}

// Update button click
document.getElementById("update-btn").addEventListener("click", function(){
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(function(pos){
            var lat = pos.coords.latitude;
            var lng = pos.coords.longitude;

            updateMap(lat, lng);

            // Save location in DB
            fetch("{% url 'update_location' %}", {
                method:"POST",
                headers:{
                    "Content-Type":"application/json",
                    "X-CSRFToken":"{{ csrf_token }}"
                },
                body: JSON.stringify({latitude:lat, longitude:lng})
            })
            .then(res=>res.json())
            .then(data=>{ alert(data.status+": "+(data.message||"Location updated")); });
        });
    } else { alert("Geolocation not supported!"); }
});
</script>
{% endblock %}
