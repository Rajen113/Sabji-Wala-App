{% extends "account/base.html" %}
{% block title %}Seller Dashboard Map{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow-sm p-4">
            <h3 class="text-center mb-3">Seller Dashboard Map</h3>
            <p class="text-center text-muted mb-4">
                Your location updates automatically. Nearby customers within 1 km are shown.
            </p>

            <div id="map" style="height:75vh; width:100%; border-radius:10px; border:2px solid #ccc;"></div>
        </div>
    </div>
</div>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
var map = L.map('map').setView([20.5937,78.9629], 13);

// OSM Tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

var sellerMarker = null;
var deliveryCircle = null;
var customerMarkers = L.layerGroup().addTo(map);

var icons = {
    seller: L.icon({ iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png', iconSize:[32,32], iconAnchor:[16,32] }),
    customer: L.icon({ iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png', iconSize:[32,32], iconAnchor:[16,32] })
};

// Watch seller position
if (navigator.geolocation){
    navigator.geolocation.watchPosition(function(pos){
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        // Update seller marker
        if (sellerMarker){ map.removeLayer(sellerMarker); }
        sellerMarker = L.marker([lat,lng], {icon: icons.seller}).addTo(map).bindPopup("<b>You are here</b>").openPopup();

        // Update delivery area circle (1 km)
        if (deliveryCircle){ map.removeLayer(deliveryCircle); }
        deliveryCircle = L.circle([lat,lng], {radius: 1000, color:'blue', fillOpacity:0.1}).addTo(map);

        map.setView([lat,lng],14);

        // Send location to server
        fetch("{% url 'update_location' %}",{
            method:"POST",
            headers:{
                "Content-Type":"application/json",
                "X-CSRFToken":"{{ csrf_token }}"
            },
            body: JSON.stringify({latitude:lat, longitude:lng})
        });

        // Fetch nearby customers
        fetch("{% url 'nearby_customers' %}")
        .then(res=>res.json())
        .then(data=>{
            customerMarkers.clearLayers();
            data.forEach(c=>{
                L.marker([c.lat,c.lng], {icon: icons.customer})
                 .bindPopup(`<b>${c.name}</b><br/><a href="tel:${c.phone}">ðŸ“ž ${c.phone}</a>`)
                 .addTo(customerMarkers);
            });
        });

    }, function(err){ console.error(err); }, {enableHighAccuracy:true, maximumAge:10000, timeout:5000});
} else {
    alert("Geolocation not supported!");
}
</script>
{% endblock %}
