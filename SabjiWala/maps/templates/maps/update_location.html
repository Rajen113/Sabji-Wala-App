{% extends 'account/base.html' %}

{% block title %}Update Location{% endblock %}

{% block content %}
<div class="container mt-4 text-center">
    <h2>Updating Your Location...</h2>
    <p class="text-muted">Please allow location access in your browser.</p>
    <p id="status" class="mt-3 fw-bold"></p>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
            document.getElementById("status").innerText = "üìç Fetching your location...";
        } else {
            document.getElementById("status").innerText = "‚ùå Geolocation not supported.";
        }
    });

    function successCallback(position) {
        var lat = position.coords.latitude;
        var lon = position.coords.longitude;

        fetch("{% url 'update_location' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: `latitude=${lat}&longitude=${lon}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                document.getElementById("status").innerText = "‚úÖ Location updated!";
                setTimeout(() => {
                    window.location.href = "{% url 'nearby_sellers_map' %}";
                }, 1500);
            } else {
                document.getElementById("status").innerText = "‚ùå Failed to update location.";
            }
        })
        .catch(error => {
            document.getElementById("status").innerText = "‚ö†Ô∏è Error updating location.";
        });
    }

    function errorCallback(error) {
        document.getElementById("status").innerText = "‚ö†Ô∏è Error: " + error.message;
    }
</script>
{% endblock %}
